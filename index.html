<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pool Control Center & Canvas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom styles for the canvas container and canvas element */

      button {
        touch-action: manipulation;
      }

      canvas {
        touch-action: manipulation;
      }
      #pool-canvas-container {
        position: relative;
        width: 100%;
        padding-top: 50%; /* 2:1 aspect ratio */
        border: 4px solid #543a29; /* Default border - Changed from user's white */
        box-sizing: border-box;
        overflow: hidden;
        border-radius: 0.5rem;
        user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
        touch-action: none;
        transition: border-color 0.3s ease; /* Smooth transition for highlight */
      }
      /* Highlight style for banking mode */
      #pool-canvas-container.banking-active {
        border-color: #3b82f6; /* Blue border highlight */
        box-shadow: 0 0 10px #3b82f6;
      }
      #pool-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: block;
        cursor: crosshair; /* Default cursor */
      }
      /* Cursor for banking mode */
      #pool-canvas.banking-cursor {
        cursor: pointer; /* Or maybe 'move' or specific icon */
      }
      .btn-press:active {
        transform: scale(0.95);
        filter: brightness(90%);
      }

      /* --- CSS Media Query for Landscape Orientation --- */
      @media (orientation: landscape) {
        #main-container {
          flex-direction: row !important;
        }
        #canvas-module {
          flex-basis: 66.666667% !important;
          width: 66.666667% !important;
          flex-grow: 1 !important;
          flex-shrink: 1 !important;
        }
        #control-module {
          flex-basis: 33.333333% !important;
          width: 33.333333% !important;
          flex-shrink: 0 !important;
        }
      }
      /* --- End Media Query --- */

      /* --- Dark mode styles --- */
      body.dark-mode {
        background-color: #1f2937;
        color: #f3f4f6;
      } /* Dark background, light text */
      body.dark-mode #control-module {
        background-color: #374151;
      } /* Darker control panel */
      body.dark-mode .text-gray-700 {
        color: #d1d5db;
      } /* Lighter gray text */
      body.dark-mode .text-gray-500 {
        color: #9ca3af;
      }
      body.dark-mode .text-gray-800 {
        color: #e5e7eb;
      } /* Lighter text for displays/buttons */
      body.dark-mode .bg-white {
        background-color: #4b5563;
        border-color: #6b7280;
      } /* Darker white areas */
      body.dark-mode .bg-gray-100 {
        background-color: #4b5563;
        border-color: #6b7280;
      } /* Darker stat boxes */
      body.dark-mode .border-gray-400 {
        border-color: #6b7280;
      } /* Darker borders */
      body.dark-mode #control1-display {
        color: #1f2937;
      } /* Keep text dark on light display */
      body.dark-mode .bg-yellow-400 {
        background-color: #f59e0b;
      } /* Keep yellow buttons vibrant */
      body.dark-mode .hover\:bg-yellow-500:hover {
        background-color: #d97706;
      }
      body.dark-mode .text-gray-800 {
        color: #1f2937;
      } /* Ensure text on yellow buttons is dark */
      body.dark-mode .bg-black {
        background-color: #4b5563;
      } /* Darker black buttons */
      body.dark-mode .hover\:bg-gray-800:hover {
        background-color: #374151;
      }
      body.dark-mode .bg-gray-400 {
        background-color: #6b7280;
      } /* Darker banking +/- buttons */
      body.dark-mode .hover\:bg-gray-500:hover {
        background-color: #4b5563;
      }
      body.dark-mode #max-banks-display {
        color: #f3f4f6;
      } /* Light text for bank display */
      body.dark-mode .bg-blue-500 {
        background-color: #3b82f6;
      } /* Keep blue vibrant */
      body.dark-mode .hover\:bg-blue-600:hover {
        background-color: #2563eb;
      }
      body.dark-mode #clear-all-btn {
        color: #1f2937;
      } /* Dark text on yellow clear button */
      body.dark-mode #undo-btn {
        color: #1f2937;
      } /* Dark text on yellow undo button */
      /* --- End Dark mode --- */

      /* Color Picker Styles */
      #color-picker-btn {
        position: relative;
        width: 3rem; /* w-12 */
        height: 3rem; /* h-12 */
        border-radius: 9999px; /* rounded-full */
        cursor: pointer;
        border: 2px solid #ccc; /* Add a border */
        overflow: hidden; /* Hide the input visually */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        transition: background-color 0.2s;
      }
      #color-picker {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0; /* Make the actual input invisible */
        cursor: pointer;
      }
    </style>
  </head>

  <body class="bg-gray-100 p-4 font-sans">
    <div
      id="main-container"
      class="flex flex-col md:flex-row gap-4 max-w-7xl mx-auto"
    >
      <div id="canvas-module" class="flex-grow md:w-2/3">
        <div class="flex flex-row gap-4 mb-4 items-center">
          <h2 class="text-xl font-semibold text-gray-700 mr-auto">
            Pool Table
          </h2>
          <button
            id="undo-btn"
            class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-full w-12 h-12 flex items-center justify-center text-2xl shadow-md transition duration-150 ease-in-out btn-press"
            title="Undo Last Line"
          >
            ‚Ü∫
          </button>
          <button
            id="clear-all-btn"
            class="bg-red-500 hover:bg-red-600 text-white font-bold rounded-full w-12 h-12 flex items-center justify-center text-2xl shadow-md transition duration-150 ease-in-out btn-press"
            title="Clear All Drawings"
          >
            üóëÔ∏è
          </button>
          <div
            id="color-picker-btn"
            style="background: var(--picker-color, #ffffff)"
            title="Change Drawing Color"
          >
            <input type="color" id="color-picker" value="#ffffff" />
          </div>
        </div>
        <div id="pool-canvas-container" class="shadow-lg">
          <canvas id="pool-canvas"></canvas>
        </div>
      </div>

      <div
        id="control-module"
        class="flex-shrink-0 md:w-1/3 bg-gray-300 p-4 rounded shadow-lg"
      >
        <div
          class="bg-white border border-gray-400 h-24 mb-4 rounded flex items-center justify-center text-gray-500"
        >
          Top Display Area (e.g., Graph)
        </div>
        <div class="flex gap-4">
          <div class="flex flex-col gap-2 w-1/4">
            <div
              class="bg-gray-100 border border-gray-400 h-10 rounded flex items-center justify-center text-sm font-medium text-gray-700"
            >
              Stat 1
            </div>
            <div
              class="bg-gray-100 border border-gray-400 h-10 rounded flex items-center justify-center text-sm font-medium text-gray-700"
            >
              Stat 2
            </div>
            <div
              class="bg-gray-100 border border-gray-400 h-10 rounded flex items-center justify-center text-sm font-medium text-gray-700"
            >
              Stat 3
            </div>
          </div>
          <div class="flex-grow flex justify-around gap-3">
            <div class="flex flex-col items-center gap-2">
              <button
                id="control1-up"
                class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center transition duration-150 ease-in-out btn-press"
                aria-label="Control 1 Up"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="2.5"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M4.5 15.75l7.5-7.5 7.5 7.5"
                  />
                </svg>
              </button>
              <div
                id="control1-display"
                class="bg-white border border-gray-400 w-16 h-10 rounded flex items-center justify-center text-lg font-semibold text-gray-800"
              >
                0
              </div>
              <button
                id="control1-down"
                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center transition duration-150 ease-in-out btn-press"
                aria-label="Control 1 Down"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="2.5"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M19.5 8.25l-7.5 7.5-7.5-7.5"
                  />
                </svg>
              </button>
            </div>
            <div class="flex flex-col items-center gap-2">
              <button
                id="control2-up"
                class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center transition duration-150 ease-in-out btn-press"
                aria-label="Control 2 Up"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="2.5"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M4.5 15.75l7.5-7.5 7.5 7.5"
                  />
                </svg>
              </button>
              <div
                id="control2-display"
                class="bg-black border border-gray-600 text-white w-16 h-10 rounded flex items-center justify-center text-lg font-semibold"
              >
                0
              </div>
              <button
                id="control2-down"
                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center transition duration-150 ease-in-out btn-press"
                aria-label="Control 2 Down"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="2.5"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M19.5 8.25l-7.5 7.5-7.5-7.5"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div
          class="mt-4 pt-4 border-t border-gray-400 flex justify-center items-center gap-4"
        >
          <button
            id="function1-btn"
            class="bg-yellow-400 hover:bg-yellow-500 data-[active=true]:bg-blue-500 data-[active=true]:text-white text-gray-800 font-bold py-2 px-4 rounded-full w-10 h-10 flex items-center justify-center text-lg transition duration-150 ease-in-out btn-press shadow-md"
            data-active="false"
            title="Toggle Banking Mode"
          >
            <div
              class="rounded-full w-12 h-12 flex items-center justify-center"
            >
              B
            </div>
          </button>
          <button
            id="function2-btn"
            class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-2 px-4 rounded-full w-10 h-10 flex items-center justify-center text-lg transition duration-150 ease-in-out btn-press shadow-md"
            title="Function 2"
          >
            <div
              class="rounded-full w-12 h-12 flex items-center justify-center"
            >
              2
            </div>
          </button>
          <button
            id="options-btn"
            class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-full w-10 h-10 flex items-center justify-center text-lg transition duration-150 ease-in-out btn-press shadow-md"
            title="More Options"
          >
            <div
              class="rounded-full w-12 h-12 flex items-center justify-center"
            >
              ...
            </div>
          </button>
          <button
            id="themeToggle"
            class="bg-gray-500 hover:bg-gray-600 text-white font-bold p-2 rounded-full w-10 h-10 flex items-center justify-center text-lg transition duration-150 ease-in-out btn-press shadow-md"
            title="Toggle Dark Mode"
          >
            <div
              class="rounded-full w-12 h-12 flex items-center justify-center"
            >
              <svg
                id="theme-icon-light"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-6 h-6"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
                />
              </svg>
              <svg
                id="theme-icon-dark"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-6 h-6 hidden"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
                />
              </svg>
            </div>
          </button>
        </div>
        <div
          id="banking-controls"
          class="mt-4 pt-4 border-t border-gray-400 text-center hidden"
        >
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Max Rails for Bank:</label
          >
          <div class="flex justify-center items-center gap-2">
            <button
              id="decrease-banks"
              class="bg-gray-400 hover:bg-gray-500 text-black font-bold rounded-full w-8 h-8 flex items-center justify-center btn-press"
            >
              -
            </button>
            <span
              id="max-banks-display"
              class="text-lg font-semibold w-8 text-center"
              >1</span
            >
            <button
              id="increase-banks"
              class="bg-gray-400 hover:bg-gray-500 text-black font-bold rounded-full w-8 h-8 flex items-center justify-center btn-press"
            >
              +
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Canvas and Context
        const canvas = document.getElementById("pool-canvas");
        const ctx = canvas.getContext("2d");
        const canvasContainer = document.getElementById(
          "pool-canvas-container"
        );

        // Buttons
        const clearAllButton = document.getElementById("clear-all-btn"); // Renamed from clearButton
        const undoButton = document.getElementById("undo-btn");
        const colorPickerInput = document.getElementById("color-picker");
        const colorPickerBtn = document.getElementById("color-picker-btn");
        const themeToggleBtn = document.getElementById("themeToggle");
        const themeIconLight = document.getElementById("theme-icon-light");
        const themeIconDark = document.getElementById("theme-icon-dark");
        const func1Button = document.getElementById("function1-btn"); // Banking Toggle
        const func2Button = document.getElementById("function2-btn");
        const optionsButton = document.getElementById("options-btn");

        // Banking Controls
        const bankingControlsDiv = document.getElementById("banking-controls");
        const decreaseBanksBtn = document.getElementById("decrease-banks");
        const increaseBanksBtn = document.getElementById("increase-banks");
        const maxBanksDisplay = document.getElementById("max-banks-display");

        // Control Displays & Buttons (Example for Control 1)
        const control1Up = document.getElementById("control1-up");
        const control1Down = document.getElementById("control1-down");
        const control1Display = document.getElementById("control1-display");
        let control1Value = 0;
        // (Add similar consts for control 2 if needed)

        // --- State ---
        let isDrawing = false;
        let isBankingMode = false;
        let maxBanks = 1;
        let currentPath = []; // For freehand drawing
        let lines = []; // Stores completed freehand lines { path: points[], color: string }
        let bankingStartPoint = null;
        let bankingCurrentEndPoint = null;
        let calculatedBankPath = [];
        let drawingColor = "#ffffff"; // Default freehand drawing color

        // --- Drawing Style Constants ---
        const DRAWING_LINE_WIDTH = 3;
        const BANKING_INITIAL_LINE_COLOR = "rgba(255, 255, 0, 0.7)"; // Yellow for user line
        const BANKING_PATH_COLOR = "rgba(0, 255, 0, 0.8)"; // Green for predicted path
        const BANKING_LINE_WIDTH = 2;

        // --- Table Drawing Constants ---
        const RAIL_COLOR = "#543a29";
        const FELT_COLOR = "#006400";
        const POCKET_COLOR = "#000000";
        const MARKING_COLOR = "rgba(255, 255, 255, 0.4)";
        const RAIL_WIDTH_RATIO = 0.05;
        const POCKET_RADIUS_RATIO = 0.04;
        const SIDE_POCKET_RADIUS_MULTIPLIER = 1.2;
        const EPSILON = 0.01;

        // --- Calculated Table Boundaries ---
        let tableBounds = { top: 0, bottom: 0, left: 0, right: 0 };

        // --- Functions ---

        /** Updates table boundaries based on canvas size. */
        function updateTableBounds() {
          const h = canvas.height;
          const w = canvas.width;
          if (w === 0 || h === 0) return;
          const railWidth = h * RAIL_WIDTH_RATIO;
          tableBounds = {
            top: railWidth,
            bottom: h - railWidth,
            left: railWidth,
            right: w - railWidth,
          };
        }

        /** Draws the pool table background. */
        function drawPoolTable() {
          const w = canvas.width;
          const h = canvas.height;
          if (w === 0 || h === 0) return;
          const railWidth = h * RAIL_WIDTH_RATIO;
          const basePocketRadius = h * POCKET_RADIUS_RATIO;
          const cornerPocketRadius = basePocketRadius * 1.414;
          const sidePocketRadius =
            basePocketRadius * SIDE_POCKET_RADIUS_MULTIPLIER;

          ctx.fillStyle = RAIL_COLOR;
          ctx.fillRect(0, 0, w, h);
          ctx.fillStyle = FELT_COLOR;
          ctx.fillRect(
            tableBounds.left,
            tableBounds.top,
            tableBounds.right - tableBounds.left,
            tableBounds.bottom - tableBounds.top
          );

          ctx.fillStyle = POCKET_COLOR;
          const drawPocket = (x, y, radius) => {
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
          };
          drawPocket(tableBounds.left, tableBounds.top, cornerPocketRadius);
          drawPocket(tableBounds.right, tableBounds.top, cornerPocketRadius);
          drawPocket(tableBounds.left, tableBounds.bottom, cornerPocketRadius);
          drawPocket(tableBounds.right, tableBounds.bottom, cornerPocketRadius);
          drawPocket(w / 2, tableBounds.top / 2, sidePocketRadius);
          drawPocket(w / 2, h - tableBounds.top / 2, sidePocketRadius);

          ctx.strokeStyle = MARKING_COLOR;
          ctx.lineWidth = Math.max(1, h * 0.003);
          const headStringX = w * 0.25;
          ctx.beginPath();
          ctx.moveTo(headStringX, tableBounds.top);
          ctx.lineTo(headStringX, tableBounds.bottom);
          ctx.stroke();
          const footSpotX = w * 0.75;
          const footSpotY = h / 2;
          ctx.beginPath();
          ctx.arc(
            footSpotX,
            footSpotY,
            Math.max(2, basePocketRadius / 4),
            0,
            Math.PI * 2
          );
          ctx.fillStyle = MARKING_COLOR;
          ctx.fill();
        }

        /** Draws a single line path with specified color and width. */
        function drawLine(path, color, width) {
          if (!path || path.length < 2) return;
          ctx.strokeStyle = color;
          ctx.lineWidth = width;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.beginPath();
          ctx.moveTo(path[0].x, path[0].y);
          for (let i = 1; i < path.length; i++) {
            ctx.lineTo(path[i].x, path[i].y);
          }
          ctx.stroke();
        }

        /** Draws a straight line segment. */
        function drawSegment(start, end, color, width) {
          drawLine([start, end], color, width);
        }

        /** Renders the entire canvas content. */
        function render() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          drawPoolTable();

          if (isBankingMode) {
            if (isDrawing && bankingStartPoint && bankingCurrentEndPoint) {
              drawSegment(
                bankingStartPoint,
                bankingCurrentEndPoint,
                BANKING_INITIAL_LINE_COLOR,
                BANKING_LINE_WIDTH
              );
            }
            calculatedBankPath.forEach((segment) => {
              drawSegment(
                segment.start,
                segment.end,
                BANKING_PATH_COLOR,
                BANKING_LINE_WIDTH
              );
            });
          } else {
            // Draw completed freehand lines with their stored colors
            lines.forEach((lineData) => {
              drawLine(lineData.path, lineData.color, DRAWING_LINE_WIDTH);
            });
            // Draw current freehand line with the selected color
            if (isDrawing && currentPath.length > 0) {
              drawLine(currentPath, drawingColor, DRAWING_LINE_WIDTH);
            }
          }
        }

        /** Resizes canvas and updates boundaries. */
        function resizeCanvas() {
          const displayWidth = canvasContainer.clientWidth;
          const displayHeight = canvasContainer.clientHeight;
          if (
            canvas.width !== displayWidth ||
            canvas.height !== displayHeight
          ) {
            canvas.width = displayWidth;
            canvas.height = displayHeight;
            console.log(`Canvas resized to: ${canvas.width}x${canvas.height}`);
            updateTableBounds();
            render();
          } else {
            updateTableBounds();
          }
        }

        /** Gets coordinates from event. */
        function getCoordinates(event) {
          const rect = canvas.getBoundingClientRect();
          let x, y;
          if (event.touches && event.touches.length > 0) {
            x = event.touches[0].clientX - rect.left;
            y = event.touches[0].clientY - rect.top;
          } else if (
            event.clientX !== undefined &&
            event.clientY !== undefined
          ) {
            x = event.clientX - rect.left;
            y = event.clientY - rect.top;
          } else {
            return null;
          }
          return { x, y };
        }

        /** Calculates the bank path. */
        function calculateBankPath(startPoint, endPoint, maxBounces) {
          let pathSegments = [];
          let currentPoint = { ...startPoint };
          let dx = endPoint.x - startPoint.x;
          let dy = endPoint.y - startPoint.y;
          let magnitude = Math.sqrt(dx * dx + dy * dy);
          if (magnitude < EPSILON) return [];
          let dirX = dx / magnitude;
          let dirY = dy / magnitude;

          for (let bounce = 0; bounce <= maxBounces; bounce++) {
            let timeToHit = Infinity;
            let hitEdge = null;
            if (dirY < -EPSILON) {
              let t = (tableBounds.top - currentPoint.y) / dirY;
              if (t > EPSILON && t < timeToHit) {
                timeToHit = t;
                hitEdge = "top";
              }
            } else if (dirY > EPSILON) {
              let t = (tableBounds.bottom - currentPoint.y) / dirY;
              if (t > EPSILON && t < timeToHit) {
                timeToHit = t;
                hitEdge = "bottom";
              }
            }
            if (dirX < -EPSILON) {
              let t = (tableBounds.left - currentPoint.x) / dirX;
              if (t > EPSILON && t < timeToHit) {
                timeToHit = t;
                hitEdge = "left";
              }
            } else if (dirX > EPSILON) {
              let t = (tableBounds.right - currentPoint.x) / dirX;
              if (t > EPSILON && t < timeToHit) {
                timeToHit = t;
                hitEdge = "right";
              }
            }

            if (
              bounce === 0 &&
              (timeToHit === Infinity || timeToHit > magnitude)
            ) {
              pathSegments.push({ start: currentPoint, end: endPoint });
              break;
            }
            if (timeToHit === Infinity) {
              let finalEndPoint = {
                x: currentPoint.x + dirX * 1000,
                y: currentPoint.y + dirY * 1000,
              };
              pathSegments.push({ start: currentPoint, end: finalEndPoint });
              break;
            } // Increased length

            let hitPoint = {
              x: currentPoint.x + dirX * timeToHit,
              y: currentPoint.y + dirY * timeToHit,
            };
            pathSegments.push({ start: currentPoint, end: hitPoint });
            if (bounce === maxBounces) break;
            if (hitEdge === "top" || hitEdge === "bottom") {
              dirY = -dirY;
            } else if (hitEdge === "left" || hitEdge === "right") {
              dirX = -dirX;
            }
            currentPoint = hitPoint;
          }
          return pathSegments;
        }

        /** Starts drawing (handles both modes). */
        function startDrawing(event) {
          event.preventDefault();
          const coords = getCoordinates(event);
          if (!coords) return;
          isDrawing = true;
          if (isBankingMode) {
            bankingStartPoint = coords;
            bankingCurrentEndPoint = coords;
            calculatedBankPath = [];
          } else {
            currentPath = [coords]; // Start new freehand path
          }
        }

        /** Continues drawing (handles both modes). */
        function draw(event) {
          if (!isDrawing) return;
          event.preventDefault();
          const coords = getCoordinates(event);
          if (!coords) return;
          if (isBankingMode) {
            bankingCurrentEndPoint = coords;
          } else {
            currentPath.push(coords);
          }
          render();
        }

        /** Stops drawing (handles both modes). */
        function stopDrawing(event) {
          if (!isDrawing) return;
          event.preventDefault();
          isDrawing = false;
          if (isBankingMode) {
            if (
              bankingStartPoint &&
              bankingCurrentEndPoint &&
              (bankingStartPoint.x !== bankingCurrentEndPoint.x ||
                bankingStartPoint.y !== bankingCurrentEndPoint.y)
            ) {
              calculatedBankPath = calculateBankPath(
                bankingStartPoint,
                bankingCurrentEndPoint,
                maxBanks
              );
            } else {
              bankingStartPoint = null;
              bankingCurrentEndPoint = null;
              calculatedBankPath = [];
            }
          } else {
            if (currentPath.length > 1) {
              // Store path along with its color
              lines.push({ path: [...currentPath], color: drawingColor });
            }
            currentPath = [];
          }
          render();
        }

        /** Clears all drawings and banking state. */
        function clearAllDrawings() {
          // Renamed function
          lines = [];
          currentPath = [];
          bankingStartPoint = null;
          bankingCurrentEndPoint = null;
          calculatedBankPath = [];
          isDrawing = false;
          render();
          console.log("All drawings cleared");
        }

        /** Undoes the last completed freehand line. */
        function undoLastLine() {
          if (!isBankingMode && lines.length > 0) {
            // Only undo in freehand mode
            lines.pop();
            render();
            console.log("Undo last line");
          }
        }

        /** Toggles Banking Mode */
        function toggleBankingMode() {
          isBankingMode = !isBankingMode;
          clearAllDrawings(); // Clear everything when switching modes

          func1Button.dataset.active = isBankingMode;
          func1Button.classList.toggle("bg-blue-500", isBankingMode);
          func1Button.classList.toggle("text-white", isBankingMode);
          func1Button.classList.toggle("bg-yellow-400", !isBankingMode);
          func1Button.classList.toggle("text-gray-800", !isBankingMode);
          canvasContainer.classList.toggle("banking-active", isBankingMode);
          canvas.classList.toggle("banking-cursor", isBankingMode);
          bankingControlsDiv.classList.toggle("hidden", !isBankingMode);
          console.log("Banking Mode:", isBankingMode);
          render();
        }

        /** Updates max banks value and display. */
        function updateMaxBanks(delta) {
          let newValue = maxBanks + delta;
          if (newValue >= 0 && newValue <= 10) {
            maxBanks = newValue;
            maxBanksDisplay.textContent = maxBanks;
            if (isBankingMode && bankingStartPoint && bankingCurrentEndPoint) {
              calculatedBankPath = calculateBankPath(
                bankingStartPoint,
                bankingCurrentEndPoint,
                maxBanks
              );
              render();
            }
          }
        }

        /** Toggles Dark/Light Theme */
        function toggleTheme() {
          document.body.classList.toggle("dark-mode");
          const isDarkMode = document.body.classList.contains("dark-mode");
          localStorage.setItem("theme", isDarkMode ? "dark" : "light");
          // Toggle icons
          themeIconLight.classList.toggle("hidden", isDarkMode);
          themeIconDark.classList.toggle("hidden", !isDarkMode);
          // Visual feedback
          themeToggleBtn.classList.add(
            "ring-2",
            "ring-offset-2",
            "ring-indigo-500"
          ); // Use a different ring color maybe
          setTimeout(
            () =>
              themeToggleBtn.classList.remove(
                "ring-2",
                "ring-offset-2",
                "ring-indigo-500"
              ),
            300
          );
        }

        /** Applies saved theme on load */
        function applySavedTheme() {
          const savedTheme = localStorage.getItem("theme");
          if (savedTheme === "dark") {
            document.body.classList.add("dark-mode");
            themeIconLight.classList.add("hidden");
            themeIconDark.classList.remove("hidden");
          } else {
            document.body.classList.remove("dark-mode");
            themeIconLight.classList.remove("hidden");
            themeIconDark.classList.add("hidden");
          }
        }

        // --- Initial Setup ---
        applySavedTheme(); // Apply theme first
        maxBanksDisplay.textContent = maxBanks;
        colorPickerBtn.style.background = drawingColor; // Set initial color picker button background
        colorPickerInput.value = drawingColor; // Sync input value
        resizeCanvas(); // Initial resize, bounds update, and render

        // --- Event Listeners ---
        const resizeObserver = new ResizeObserver((entries) => {
          for (let entry of entries) {
            if (entry.target === canvasContainer) {
              resizeCanvas();
            }
          }
        });
        resizeObserver.observe(canvasContainer);

        // Drawing Listeners
        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", draw);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("mouseleave", stopDrawing);
        canvas.addEventListener("touchstart", startDrawing, { passive: false });
        canvas.addEventListener("touchmove", draw, { passive: false });
        canvas.addEventListener("touchend", stopDrawing);
        canvas.addEventListener("touchcancel", stopDrawing);

        // Button Listeners
        clearAllButton.addEventListener("click", clearAllDrawings); // Use renamed function
        undoButton.addEventListener("click", undoLastLine);
        themeToggleBtn.addEventListener("click", toggleTheme);
        func1Button.addEventListener("click", toggleBankingMode);
        func2Button.addEventListener("click", () => {
          console.log("Function 2 Clicked");
          alert("Function 2 Activated!");
        });
        optionsButton.addEventListener("click", () => {
          console.log("Options Clicked");
          alert("More options!");
        });

        // Banking Control Listeners
        decreaseBanksBtn.addEventListener("click", () => updateMaxBanks(-1));
        increaseBanksBtn.addEventListener("click", () => updateMaxBanks(1));

        // Color Picker Listener
        colorPickerInput.addEventListener("input", (e) => {
          drawingColor = e.target.value;
          colorPickerBtn.style.background = drawingColor; // Update button background visually
          // Note: No need for CSS variable here if we just set background directly
        });

        // Control 1 Listeners (Example)
        control1Up.addEventListener("click", () => {
          control1Value++;
          control1Display.textContent = control1Value;
          control1Display.classList.add(
            "bg-green-200",
            "transition",
            "duration-150"
          ); // Added feedback like user code
          setTimeout(
            () => control1Display.classList.remove("bg-green-200"),
            200
          );
        });
        control1Down.addEventListener("click", () => {
          control1Value--;
          control1Display.textContent = control1Value;
          control1Display.classList.add(
            "bg-red-200",
            "transition",
            "duration-150"
          ); // Added feedback like user code
          setTimeout(() => control1Display.classList.remove("bg-red-200"), 200);
        });
        // Add listeners for Control 2 similarly if needed
      }); // End DOMContentLoaded
    </script>
  </body>
</html>
